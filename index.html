<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallAnalyzer Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Mic = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
        );

        const MicOff = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="2" x2="22" y1="2" y2="22"/>
                <path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/>
                <path d="M5 10v2a7 7 0 0 0 12 5"/>
                <path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/>
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12"/>
                <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
        );

        const Play = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
        );

        const Pause = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        );

        const Download = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        const FileText = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" x2="8" y1="13" y2="13"/>
                <line x1="16" x2="8" y1="17" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </svg>
        );

        const CheckCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const XCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" x2="9" y1="9" y2="15"/>
                <line x1="9" x2="15" y1="9" y2="15"/>
            </svg>
        );

        const AlertCircle = () => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" x2="12" y1="8" y2="12"/>
                <line x1="12" x2="12.01" y1="16" y2="16"/>
            </svg>
        );

        const CallAnalyzerPro = () => {
            const [isRecording, setIsRecording] = useState(false);
            const [isPaused, setIsPaused] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [analysis, setAnalysis] = useState(null);
            const [audioLevel, setAudioLevel] = useState(0);
            const [duration, setDuration] = useState(0);
            const [scriptChecks, setScriptChecks] = useState([]);
            const [selectedScript, setSelectedScript] = useState('vente');
            
            const recognitionRef = useRef(null);
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const timerRef = useRef(null);

            const scripts = {
                vente: [
                    "Bonjour, je m'appelle",
                    "Comment allez-vous",
                    "Je vous appelle concernant",
                    "Auriez-vous quelques minutes",
                    "Puis-je vous poser quelques questions",
                    "Merci pour votre temps"
                ],
                support: [
                    "Bonjour",
                    "Puis-je avoir votre numéro de dossier",
                    "Je comprends votre situation",
                    "Je vais faire le nécessaire",
                    "Y a-t-il autre chose",
                    "Bonne journée"
                ],
                satisfaction: [
                    "Bonjour",
                    "Êtes-vous satisfait",
                    "Pouvez-vous évaluer",
                    "Qu'est-ce qui pourrait être amélioré",
                    "Merci pour votre retour"
                ]
            };

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'fr-FR';

                    recognitionRef.current.onresult = (event) => {
                        let finalTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcriptPart = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcriptPart + ' ';
                            }
                        }

                        if (finalTranscript) {
                            setTranscript(prev => prev + finalTranscript);
                            checkScript(finalTranscript);
                        }
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Erreur de reconnaissance:', event.error);
                    };
                }

                return () => {
                    if (timerRef.current) clearInterval(timerRef.current);
                    if (audioContextRef.current) audioContextRef.current.close();
                };
            }, []);

            const checkScript = (text) => {
                const currentScript = scripts[selectedScript];
                const lowerText = text.toLowerCase();
                
                currentScript.forEach((phrase, index) => {
                    if (lowerText.includes(phrase.toLowerCase())) {
                        setScriptChecks(prev => {
                            if (!prev.includes(index)) {
                                return [...prev, index];
                            }
                            return prev;
                        });
                    }
                });
            };

            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    analyserRef.current = audioContextRef.current.createAnalyser();
                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    source.connect(analyserRef.current);
                    analyserRef.current.fftSize = 256;
                    
                    const bufferLength = analyserRef.current.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);

                    const updateAudioLevel = () => {
                        if (analyserRef.current && !isPaused) {
                            analyserRef.current.getByteFrequencyData(dataArray);
                            const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                            setAudioLevel(average);
                        }
                        if (isRecording) {
                            requestAnimationFrame(updateAudioLevel);
                        }
                    };
                    updateAudioLevel();

                    if (recognitionRef.current) {
                        recognitionRef.current.start();
                    }

                    timerRef.current = setInterval(() => {
                        setDuration(prev => prev + 1);
                    }, 1000);

                    setIsRecording(true);
                    setTranscript('');
                    setScriptChecks([]);
                    setAnalysis(null);
                } catch (error) {
                    alert('Erreur: Impossible d\'accéder au microphone. Vérifiez les permissions.');
                }
            };

            const pauseRecording = () => {
                if (recognitionRef.current) {
                    if (isPaused) {
                        recognitionRef.current.start();
                    } else {
                        recognitionRef.current.stop();
                    }
                }
                setIsPaused(!isPaused);
            };

            const stopRecording = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                }
                if (timerRef.current) {
                    clearInterval(timerRef.current);
                }
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                }
                
                setIsRecording(false);
                setIsPaused(false);
                generateAnalysis();
            };

            const generateAnalysis = () => {
                const currentScript = scripts[selectedScript];
                const completionRate = (scriptChecks.length / currentScript.length) * 100;
                const wordCount = transcript.trim().split(/\s+/).length;
                const avgWordsPerMin = Math.round((wordCount / duration) * 60);

                setAnalysis({
                    duration: formatDuration(duration),
                    wordCount,
                    avgWordsPerMin,
                    completionRate: completionRate.toFixed(0),
                    missingPhrases: currentScript.filter((_, index) => !scriptChecks.includes(index)),
                    sentiment: analyzeSentiment(transcript)
                });
            };

            const analyzeSentiment = (text) => {
                const positiveWords = ['merci', 'excellent', 'parfait', 'super', 'génial', 'bien', 'content', 'satisfait'];
                const negativeWords = ['problème', 'désolé', 'erreur', 'mauvais', 'insatisfait', 'difficile'];
                
                const lowerText = text.toLowerCase();
                const positiveCount = positiveWords.filter(word => lowerText.includes(word)).length;
                const negativeCount = negativeWords.filter(word => lowerText.includes(word)).length;
                
                if (positiveCount > negativeCount) return 'Positif';
                if (negativeCount > positiveCount) return 'Négatif';
                return 'Neutre';
            };

            const formatDuration = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const downloadReport = () => {
                const report = `
=== RAPPORT D'ANALYSE D'APPEL ===

Date: ${new Date().toLocaleDateString('fr-FR')}
Durée: ${analysis.duration}
Nombre de mots: ${analysis.wordCount}
Mots par minute: ${analysis.avgWordsPerMin}
Taux de complétion du script: ${analysis.completionRate}%
Sentiment: ${analysis.sentiment}

=== TRANSCRIPTION ===
${transcript}

=== PHRASES MANQUANTES ===
${analysis.missingPhrases.join('\n')}
                `.trim();

                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport-appel-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8">
                            <div className="text-center mb-8">
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">CallAnalyzer Pro</h1>
                                <p className="text-gray-600">Analyse d'appels en temps réel avec détection de script</p>
                            </div>

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Type de script à vérifier</label>
                                <select 
                                    value={selectedScript} 
                                    onChange={(e) => setSelectedScript(e.target.value)}
                                    disabled={isRecording}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="vente">Script de vente</option>
                                    <option value="support">Script support client</option>
                                    <option value="satisfaction">Enquête satisfaction</option>
                                </select>
                            </div>

                            <div className="flex justify-center gap-4 mb-8">
                                {!isRecording ? (
                                    <button
                                        onClick={startRecording}
                                        className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-full font-semibold transition shadow-lg"
                                    >
                                        <Mic />
                                        Démarrer l'enregistrement
                                    </button>
                                ) : (
                                    <>
                                        <button
                                            onClick={pauseRecording}
                                            className="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-4 rounded-full font-semibold transition"
                                        >
                                            {isPaused ? <Play /> : <Pause />}
                                            {isPaused ? 'Reprendre' : 'Pause'}
                                        </button>
                                        <button
                                            onClick={stopRecording}
                                            className="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-6 py-4 rounded-full font-semibold transition"
                                        >
                                            <MicOff />
                                            Arrêter
                                        </button>
                                    </>
                                )}
                            </div>

                            {isRecording && (
                                <div className="mb-8">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-medium text-gray-700">Niveau audio</span>
                                        <span className="text-lg font-bold text-indigo-600">{formatDuration(duration)}</span>
                                    </div>
                                    <div className="h-4 bg-gray-200 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-gradient-to-r from-green-400 to-green-600 transition-all duration-100"
                                            style={{ width: `${Math.min(100, audioLevel)}%` }}
                                        />
                                    </div>
                                </div>
                            )}

                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="bg-gray-50 rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <CheckCircle />
                                        Vérification du script
                                    </h3>
                                    <div className="space-y-3">
                                        {scripts[selectedScript].map((phrase, index) => (
                                            <div 
                                                key={index}
                                                className={`flex items-start gap-3 p-3 rounded-lg transition ${
                                                    scriptChecks.includes(index) ? 'bg-green-100' : 'bg-white'
                                                }`}
                                            >
                                                {scriptChecks.includes(index) ? (
                                                    <CheckCircle />
                                                ) : (
                                                    <div className="w-5 h-5 border-2 border-gray-300 rounded-full flex-shrink-0 mt-0.5" />
                                                )}
                                                <span className={`text-sm ${scriptChecks.includes(index) ? 'text-green-800 font-medium' : 'text-gray-600'}`}>
                                                    {phrase}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-gray-200">
                                        <div className="text-sm text-gray-600">
                                            Progression: <span className="font-bold text-indigo-600">
                                                {scriptChecks.length}/{scripts[selectedScript].length}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-50 rounded-xl p-6">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                        <FileText />
                                        Transcription en direct
                                    </h3>
                                    <div className="bg-white rounded-lg p-4 h-80 overflow-y-auto text-sm text-gray-700 leading-relaxed">
                                        {transcript || (
                                            <span className="text-gray-400 italic">
                                                La transcription apparaîtra ici pendant l'enregistrement...
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {analysis && (
                                <div className="mt-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-2xl font-bold text-gray-800">Synthèse de l'appel</h3>
                                        <button
                                            onClick={downloadReport}
                                            className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition"
                                        >
                                            <Download />
                                            Télécharger
                                        </button>
                                    </div>

                                    <div className="grid md:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-white rounded-lg p-4 text-center">
                                            <div className="text-3xl font-bold text-indigo-600">{analysis.duration}</div>
                                            <div className="text-sm text-gray-600 mt-1">Durée</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center">
                                            <div className="text-3xl font-bold text-indigo-600">{analysis.wordCount}</div>
                                            <div className="text-sm text-gray-600 mt-1">Mots prononcés</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center">
                                            <div className="text-3xl font-bold text-indigo-600">{analysis.avgWordsPerMin}</div>
                                            <div className="text-sm text-gray-600 mt-1">Mots/minute</div>
                                        </div>
                                        <div className="bg-white rounded-lg p-4 text-center">
                                            <div className="text-3xl font-bold text-indigo-600">{analysis.completionRate}%</div>
                                            <div className="text-sm text-gray-600 mt-1">Complétion</div>
                                        </div>
                                    </div>

                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="bg-white rounded-lg p-4">
                                            <h4 className="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                                <AlertCircle />
                                                Phrases manquantes
                                            </h4>
                                            {analysis.missingPhrases.length > 0 ? (
                                                <ul className="space-y-2">
                                                    {analysis.missingPhrases.map((phrase, index) => (
                                                        <li key={index} className="text-sm text-gray-600 flex items-start gap-2">
                                                            <XCircle />
                                                            {phrase}
                                                        </li>
                                                    ))}
                                                </ul>
                                            ) : (
                                                <p className="text-green-600 text-sm">Toutes les phrases ont été prononcées !</p>
                                            )}
                                        </div>

                                        <div className="bg-white rounded-lg p-4">
                                            <h4 className="font-semibold text-gray-800 mb-2">Sentiment général</h4>
                                            <div className={`inline-block px-4 py-2 rounded-full text-sm font-semibold ${
                                                analysis.sentiment === 'Positif' ? 'bg-green-100 text-green-800' :
                                                analysis.sentiment === 'Négatif' ? 'bg-red-100 text-red-800' :
                                                'bg-gray-100 text-gray-800'
                                            }`}>
                                                {analysis.sentiment}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                                <strong>Note:</strong> Cette application utilise la Web Speech API de votre navigateur (gratuite). 
                                Vos données restent privées et ne sont pas envoyées à des serveurs externes.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CallAnalyzerPro />, document.getElementById('root'));
    </script>
</body>
</html>
